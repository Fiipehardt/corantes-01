<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Conferência de Estoque — Referências</title>
  <style>
    :root{
      --bg:#0f172a;        /* slate-900 */
      --card:#111827;      /* gray-900 */
      --muted:#94a3b8;     /* slate-400 */
      --text:#e5e7eb;      /* gray-200 */
      --accent:#22c55e;    /* green-500 */
      --danger:#ef4444;    /* red-500 */
      --warn:#f59e0b;      /* amber-500 */
      --soft:#1f2937;      /* gray-800 */
      --line:#374151;      /* gray-700 */
      --chip:#0ea5e9;      /* sky-500 */
      --btn:#2563eb;       /* blue-600 */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
    }
    header{
      position:sticky; top:0; z-index:10;
      background:linear-gradient(180deg, rgba(15,23,42,0.98), rgba(15,23,42,0.9));
      backdrop-filter: blur(6px);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:980px; margin:0 auto; padding:12px 14px}
    h1{font-size:18px; margin:4px 0 10px 0}
    .tools{
      display:grid; grid-template-columns: 1fr; gap:8px;
    }
    .row{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    }
    input[type="text"], input[type="number"], select{
      background:var(--soft); color:var(--text); border:1px solid var(--line);
      border-radius:10px; padding:10px 12px; outline:none;
      width:100%;
    }
    input[type="number"]{appearance:textfield}
    .btn{
      background:var(--btn); color:white; border:none; padding:10px 12px;
      border-radius:999px; cursor:pointer; font-weight:600;
    }
    .btn.secondary{ background:var(--soft); border:1px solid var(--line); color:var(--text) }
    .btn.danger{ background:var(--danger) }
    .btn.warn{ background:var(--warn) }
    .btn.accent{ background:var(--accent) }
    .btn.small{ padding:6px 10px; font-weight:600 }
    .chips{ display:flex; flex-wrap:wrap; gap:6px }
    .chip{
      background:var(--soft); color:var(--text); border:1px solid var(--line);
      padding:6px 10px; border-radius:999px; font-size:12px; cursor:pointer;
    }
    .chip.active{ background:var(--chip); border-color:transparent; color:white }
    main{ padding:14px }
    .card{
      background:var(--card); border:1px solid var(--line);
      border-radius:16px; padding:10px 10px; margin-bottom:10px;
    }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:8px; align-items:center }
    .item{
      display:grid; grid-template-columns: 1fr 0.5fr 0.5fr auto; gap:8px; align-items:center;
      padding:8px; border:1px dashed var(--line); border-radius:12px;
      background:rgba(255,255,255,0.02);
    }
    .item.low{ border-color: var(--danger) }
    .tag{ font-size:12px; opacity:.8 }
    .ref{ font-weight:700; }
    .muted{ color:var(--muted) }
    .hide{ display:none !important }
    .list{ display:grid; gap:8px }
    .footer{
      position:sticky; bottom:0; background:linear-gradient(0deg, rgba(15,23,42,0.98), rgba(15,23,42,0.9));
      border-top:1px solid var(--line); padding:10px 14px;
    }
    .footer .row{ justify-content:space-between }
    @media (min-width:680px){
      .tools{ grid-template-columns: 1fr 1fr }
    }
    @media print{
      header,.footer,.controls{ display:none !important }
      body{ background:white; color:black }
      .card{ border:none }
      .item{ border:1px solid #ccc }
    }
    .kbd{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
          background:var(--soft); border:1px solid var(--line); padding:2px 6px; border-radius:6px; font-size:12px }
    .help{ font-size:12px; color:var(--muted) }
    .orderArea{
      width:100%; min-height:140px; padding:10px; border-radius:12px;
      background:var(--soft); color:var(--text); border:1px solid var(--line);
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Conferência de Estoque</h1>
      <div class="tools">
        <div class="row">
          <input id="search" type="text" placeholder="Buscar referência ou etiqueta (ex.: 96-7.11, G, ANETA)"/>
          <button class="btn secondary" id="clearSearch">Limpar</button>
        </div>
        <div class="row controls">
          <div class="chips" id="chips"></div>
          <label class="help"><input type="checkbox" id="onlyLow"/> Mostrar apenas itens para pedir</label>
        </div>
      </div>
      <div class="help" style="margin-top:6px">
        Dica: toque no campo <span class="kbd">Qtd</span> para registrar o que há no estoque. Ajuste o <span class="kbd">Mín</span> conforme sua necessidade. Os dados ficam salvos neste dispositivo.
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="card">
      <div class="list" id="list"></div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between; gap:8px; flex-wrap:wrap">
        <button class="btn accent" id="genOrder">Gerar lista de pedido</button>
        <button class="btn secondary" id="printPage">Imprimir</button>
        <button class="btn warn" id="resetQty">Zerar apenas quantidades</button>
        <button class="btn danger" id="resetAll">Apagar tudo (quantidades e mínimos)</button>
      </div>
      <div style="margin-top:10px">
        <textarea id="orderOutput" class="orderArea" placeholder="A lista de pedido aparecerá aqui…"></textarea>
      </div>
      <div class="row" style="margin-top:8px; gap:8px">
        <button class="btn secondary small" id="copyOrder">Copiar</button>
        <button class="btn small" id="whatsOrder">Enviar no WhatsApp</button>
      </div>
    </div>
  </main>

  <div class="footer">
    <div class="wrap">
      <div class="row">
        <div class="help">Total de itens: <span id="countAll">0</span> • Para pedir: <span id="countLow">0</span></div>
        <div class="help">Salvo localmente • Funciona offline</div>
      </div>
    </div>
  </div>

<script>
const DATA = [
  // Referências numéricas com etiqueta (letra)
  { ref:"96-7.11", tag:"G" },
  { ref:"96-26.11", tag:"Z" },
  { ref:"96-3.11", tag:"C" },
  { ref:"96-5.11", tag:"E" },
  { ref:"96-23.04", tag:"W" },
  { ref:"96-12.11", tag:"L" },
  { ref:"96-2.11", tag:"B" },
  { ref:"96-4.11", tag:"D" },
  { ref:"96-13.11", tag:"M" },
  { ref:"96-6.11", tag:"F" },
  { ref:"96-10.11", tag:"J" },
  { ref:"96-22.11", tag:"V" },

  // Itens ANETA por letra
  { ref:"C", tag:"ANETA" },
  { ref:"G", tag:"ANETA" },
  { ref:"B", tag:"ANETA" },
  { ref:"L", tag:"ANETA" },
  { ref:"M", tag:"ANETA" },
  { ref:"Z", tag:"ANETA" },
  { ref:"V", tag:"ANETA" },
  { ref:"J", tag:"ANETA" },
  { ref:"F", tag:"ANETA" },
  { ref:"E", tag:"ANETA" },
  { ref:"D", tag:"ANETA" },
  { ref:"W", tag:"ANETA" },
];

// --- Storage helpers
const KEY = "estoque_ref_v1";
function loadState(){
  try { return JSON.parse(localStorage.getItem(KEY)) || {}; } catch(e){ return {}; }
}
function saveState(state){
  localStorage.setItem(KEY, JSON.stringify(state));
}

// --- Build UI
const listEl = document.getElementById("list");
const chipsEl = document.getElementById("chips");
const searchEl = document.getElementById("search");
const clearSearchEl = document.getElementById("clearSearch");
const onlyLowEl = document.getElementById("onlyLow");
const countAllEl = document.getElementById("countAll");
const countLowEl = document.getElementById("countLow");
const orderOutputEl = document.getElementById("orderOutput");

const tags = Array.from(new Set(DATA.map(i=>i.tag))).sort();
let activeTag = null;
let state = loadState();

function getItemKey(item){ return `${item.ref}__${item.tag}`; }
function getItemState(item){
  const key = getItemKey(item);
  const s = state[key] || { qty:0, min:1, note:"" };
  // ensure numbers
  s.qty = Number.isFinite(+s.qty) ? +s.qty : 0;
  s.min = Number.isFinite(+s.min) ? +s.min : 1;
  return s;
}
function setItemState(item, patch){
  const key = getItemKey(item);
  state[key] = { ...getItemState(item), ...patch };
  saveState(state);
  updateCounts();
}

function makeChip(tag){
  const b = document.createElement("button");
  b.className = "chip";
  b.textContent = tag;
  b.onclick = ()=>{
    activeTag = (activeTag === tag) ? null : tag;
    render();
  };
  return b;
}

function itemNeedsOrder(item){
  const st = getItemState(item);
  return st.qty < st.min;
}

function render(){
  // Chips
  chipsEl.innerHTML = "";
  const allChip = document.createElement("button");
  allChip.className = "chip" + (activeTag===null ? " active": "");
  allChip.textContent = "Todos";
  allChip.onclick = ()=>{ activeTag=null; render(); };
  chipsEl.appendChild(allChip);
  tags.forEach(tag=>{
    const c = makeChip(tag);
    if(activeTag===tag) c.classList.add("active");
    chipsEl.appendChild(c);
  });

  // List
  const q = searchEl.value.trim().toLowerCase();
  listEl.innerHTML = "";
  let lows = 0;
  let total = 0;
  DATA.forEach(item=>{
    const txt = (item.ref + " " + item.tag).toLowerCase();
    if(q && !txt.includes(q)) return;
    if(activeTag && item.tag !== activeTag) return;
    const st = getItemState(item);
    const needs = st.qty < st.min;
    if(onlyLowEl.checked && !needs) return;

    const row = document.createElement("div");
    row.className = "item" + (needs? " low": "");

    const left = document.createElement("div");
    const title = document.createElement("div");
    title.className = "ref";
    title.textContent = item.ref;
    const sub = document.createElement("div");
    sub.className = "tag muted";
    sub.textContent = item.tag;
    left.appendChild(title);
    left.appendChild(sub);

    const qty = document.createElement("input");
    qty.type = "number"; qty.inputmode="numeric"; qty.min="0"; qty.step="1";
    qty.value = st.qty;
    qty.title = "Quantidade atual";
    qty.oninput = (e)=>{
      const v = Math.max(0, parseInt(e.target.value||"0",10));
      e.target.value = v;
      setItemState(item, { qty:v });
      row.classList.toggle("low", v < getItemState(item).min);
    };

    const min = document.createElement("input");
    min.type = "number"; min.inputmode="numeric"; min.min="0"; min.step="1";
    min.value = st.min;
    min.title = "Estoque mínimo desejado";
    min.oninput = (e)=>{
      const v = Math.max(0, parseInt(e.target.value||"0",10));
      e.target.value = v;
      setItemState(item, { min:v });
      row.classList.toggle("low", getItemState(item).qty < v);
    };

    const need = document.createElement("div");
    need.style.textAlign="right";
    const span = document.createElement("div");
    span.className = "muted";
    span.textContent = "Pedir";
    const strong = document.createElement("div");
    strong.style.fontWeight="800";
    const ask = Math.max(0, st.min - st.qty);
    strong.textContent = ask;
    need.appendChild(span);
    need.appendChild(strong);

    // recompute ask when fields change
    const updateAsk = ()=>{
      const s = getItemState(item);
      strong.textContent = Math.max(0, s.min - s.qty);
    };
    qty.addEventListener("input", updateAsk);
    min.addEventListener("input", updateAsk);

    row.appendChild(left);
    row.appendChild(qty);
    row.appendChild(min);
    row.appendChild(need);
    listEl.appendChild(row);

    total++;
    if(needs) lows++;
  });
  countAllEl.textContent = total;
  // Count lows disregarding filters
  const lowCount = DATA.filter(item=> getItemState(item).qty < getItemState(item).min).length;
  countLowEl.textContent = lowCount;
}

function updateCounts(){ render(); }

// Order generation
function generateOrderText(){
  const lines = [];
  lines.push("** Lista de Pedido **");
  const now = new Date();
  lines.push("Data: " + now.toLocaleString());
  lines.push("");
  let any = false;
  DATA.forEach(item=>{
    const st = getItemState(item);
    const ask = Math.max(0, st.min - st.qty);
    if(ask>0){
      any = true;
      lines.push(`${item.ref} (${item.tag}) — Qtd: ${ask}  [Mín ${st.min} | Tem ${st.qty}]`);
    }
  });
  if(!any) lines.push("Nada a pedir. ✅");
  return lines.join("\n");
}

// Events
searchEl.addEventListener("input", render);
clearSearchEl.addEventListener("click", ()=>{ searchEl.value=""; render(); });
onlyLowEl.addEventListener("change", render);

document.getElementById("genOrder").addEventListener("click", ()=>{
  orderOutputEl.value = generateOrderText();
  orderOutputEl.focus();
  orderOutputEl.select();
});
document.getElementById("copyOrder").addEventListener("click", async ()=>{
  if(!orderOutputEl.value) orderOutputEl.value = generateOrderText();
  try{
    await navigator.clipboard.writeText(orderOutputEl.value);
    alert("Lista copiada para a área de transferência.");
  }catch(e){
    alert("Não foi possível copiar automaticamente. Selecione e copie manualmente.");
  }
});
document.getElementById("whatsOrder").addEventListener("click", ()=>{
  if(!orderOutputEl.value) orderOutputEl.value = generateOrderText();
  const msg = encodeURIComponent(orderOutputEl.value);
  // Abre WhatsApp se disponível
  const url = `https://wa.me/?text=${msg}`;
  window.open(url, "_blank");
});
document.getElementById("printPage").addEventListener("click", ()=> window.print());

document.getElementById("resetQty").addEventListener("click", ()=>{
  if(!confirm("Zerar SOMENTE as quantidades?")) return;
  DATA.forEach(item=>{
    const key = getItemKey(item);
    const st = getItemState(item);
    state[key] = { ...st, qty:0 };
  });
  saveState(state);
  render();
});
document.getElementById("resetAll").addEventListener("click", ()=>{
  if(!confirm("Apagar TUDO: quantidades e mínimos?")) return;
  localStorage.removeItem(KEY);
  state = loadState();
  render();
});

// Init
render();
</script>
</body>
</html>
